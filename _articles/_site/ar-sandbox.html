<p><a href="https://www.youtube.com/watch?v=uTPOE2XceEA">AR Sandbox Video</a></p>

<p>The <a href="https://arsandbox.ucdavis.edu/">Augmented Reality Sandbox</a> was developed by <a href="http://idav.ucdavis.edu/~okreylos/">Oliver Kreylos</a> at <a href="https://www.ucdavis.edu/">UC Davis</a>.</p>

<p>In hopes of giving this awesome software wider exposure and making it easier to consume, System76 <a href="https://launchpad.net/~system76-dev/+archive/ubuntu/weekend-project">packaged this software for Ubuntu-based OSes</a> and wrote this tutorial.</p>

<h3 id="required-hardware">Required Hardware</h3>

<p>This tutorial focuses on installing and calibrating the software, but won’t cover the details of the hardware setup.</p>

<p>For detailed information on the hardware setup, see the <a href="https://arsandbox.ucdavis.edu/instructions/hardware-2/">AR Sandbox hardware tutorial</a>, but in brief you’ll need:</p>

<ul>
  <li>
    <p>A first generation Kinect</p>
  </li>
  <li>
    <p>A short-throw digital projector like the <a href="https://www.amazon.com/dp/B010MDRIEA">BenQ MW632ST</a></p>
  </li>
  <li>
    <p>A sandbox for your sand (our sandbox is 40 inches by 30 inches by 8 inches)</p>
  </li>
  <li>
    <p>Roughly 200 pounds of white sand like <a href="https://www.amazon.com/Sandtastik-White-Play-Sand-SND025/dp/B001AZ0CGG">Sandtastik White Sandbox Sand</a></p>
  </li>
  <li>
    <p>A Linux-friendly computer with a fast NVIDIA GPU, running Pop!_OS/Ubuntu 18.04 or newer (any flavor).</p>
  </li>
</ul>

<p>In terms of System76 computers we recommend the <a href="https://system76.com/laptops/oryx">Oryx Pro</a> laptop or <a href="https://system76.com/cart/configure/thelio-r1">Thelio</a> desktop with the fastest available GPU.</p>

<h2 id="install-software">Install Software</h2>

<ul>
  <li>
    <p>You’ll need a computer running Pop!_OS or Ubuntu 18.04 or newer.</p>
  </li>
  <li>
    <p>Add the needed PPA and install the software by opening a terminal and running these three commands:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo add-apt-repository -ys ppa:system76-dev/weekend-project
sudo apt-get update
sudo apt-get install arsandbox
</code></pre></div></div>

<ul>
  <li>Find out what your username is by running this command in the terminal:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>whoami
</code></pre></div></div>

<ul>
  <li>Add yourself to the vrui-grp group with this command, replacing USERNAME with the user-name returned by the whoami command above:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo adduser USERNAME vrui-grp
</code></pre></div></div>

<ul>
  <li>Reboot your computer so all of the above changes take effect.</li>
</ul>

<h2 id="calibrate-kinect">Calibrate Kinect</h2>

<ul>
  <li>Plug in your first-generation Kinect device, then open a terminal and run:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KinectUtil getCalib 0
</code></pre></div></div>

<p>This will download the intrinsic calibration parameters directly from your Kinect’s firmware and then write the result to a file in <code class="language-plaintext highlighter-rouge">/etc/Vrui-3.1/Kinect-2.8/.</code></p>

<h2 id="align-kinect-above-sandbox">Align Kinect above sandbox</h2>

<ul>
  <li>Open a terminal and run:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RawKinectViewer -compress 0
</code></pre></div></div>

<ul>
  <li>Maximize this window so it’s easier to see your sandbox:</li>
</ul>

<p><img src="/images/ar-sandbox/3-A-maximize-3eb069c85a.png" alt="RawKinectViewer" /></p>

<p>The image on the left is the depth view, the right is the standard camera view:</p>

<p><img src="/images/ar-sandbox/3-B-align-kinect-73dd8344d5.png" alt="Align Kinect" /></p>

<p>The Augmented Reality Sandbox only uses the depth view (left), but the camera view (right) is still helpful in aligning your Kinect.</p>

<ul>
  <li>
    <p>The depth view needs to cover the entire interior of your sandbox. It’s okay if it overlaps it slightly.</p>
  </li>
  <li>
    <p>Hit Esc to close the <code class="language-plaintext highlighter-rouge">RawKinectViewer</code>.</p>
  </li>
</ul>

<h2 id="calculate-base-plane">Calculate base plane</h2>

<ul>
  <li>There are two ways to calculate the base plane. If you haven’t yet filled your sandbox with sand, you can calculate the base plane using a region on the floor of your sandbox.</li>
</ul>

<p>On the other hand, if you’ve already filed your sandbox with sand, you can calculate the base plane by placing a piece of poster board (or a similar flat surface) on top of your sandbox, which is what we’ll do in this example:</p>

<p><img src="/images/ar-sandbox/4-A-posterboard-718b802347.jpg" alt="Align Kinect" /></p>

<ul>
  <li>From a terminal, launch the RawKinectViewer:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RawKinectViewer -compress 0
</code></pre></div></div>

<ul>
  <li>Maximize this window so it’s easier to see your sandbox:</li>
</ul>

<p><img src="/images/ar-sandbox/3-A-maximize-3eb069c85a.png" alt="RawKinectViewer" /></p>

<ul>
  <li>Press and hold the right mouse button, move your cursor over Average Frames, then release the mouse button:</li>
</ul>

<p><img src="/images/ar-sandbox/4-B-average-frames-1ba827544a.png" alt="Right Click Menu" /></p>

<ul>
  <li>Press and hold the 1 key, move your cursor over Extract Planes, then release the 1 key:</li>
</ul>

<p><img src="/images/ar-sandbox/4-C-extract-plane-1cbd8abb5e.png" alt="Extract Planes" /></p>

<ul>
  <li>You now need to draw a rectangle that fits within the interior of your flat surface (in the depth view). You want some space between your rectangle and the edges of your flat surface.
Start with your cursor near the top-left corner of your flat surface. Press and hold the 1 key, drag out a rectangle toward the bottom-right corner, then release the 1 key:</li>
</ul>

<p><img src="/images/ar-sandbox/4-D-drag-rectangle-a8b53ecc87.png" alt="Kinect Area View" /></p>

<ul>
  <li>
    <p>Hit Esc to close the RawKinectViewer.</p>
  </li>
  <li>
    <p>In the terminal you’ll see two lines printed. Select the portion of the 2nd line shown below, then right click and select Copy:</p>
  </li>
</ul>

<p><img src="/images/ar-sandbox/4-E-terminal-output-25a90e21ae.png" alt="Space Plane" /></p>

<ul>
  <li>Edit the BoxLayout.txt file by running this command from the terminal:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gedit /etc/SARndbox-1.6/BoxLayout.txt
</code></pre></div></div>

<ul>
  <li>Paste the line you just copied over the first line in the <code class="language-plaintext highlighter-rouge">BoxLayout.txt</code> file.</li>
</ul>

<p>You also need edit this line, replacing the “=” (equal sign) with a “,” (comma).</p>

<p>You should end up with a first line something like this:</p>

<p><img src="/images/ar-sandbox/4-F-gedit-eb460dffb4.png" alt="Gedit BoxLayout.txt" /></p>

<ul>
  <li>Save the file and close <code class="language-plaintext highlighter-rouge">gedit</code>.</li>
</ul>

<h2 id="measure-3d-extents-of-sand-surface">Measure 3D extents of sand surface</h2>

<ul>
  <li>This step requires you to have filed your sandbox with sand. You want the sand surface to be as level as possible, but it doesn’t need to be perfectly level.</li>
</ul>

<p>If you placed a piece of poster board (or another flat surface) on top of your sandbox in the previous step, you’ll need to remove it for this step.</p>

<ul>
  <li>From a terminal, again launch the RawKinectViewer:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RawKinectViewer -compress 0
</code></pre></div></div>

<ul>
  <li>Maximize this window so it’s easier to see your sandbox:</li>
</ul>

<p><img src="/images/ar-sandbox/3-A-maximize-3eb069c85a.png" alt="RawKinectViewer" /></p>

<ul>
  <li>Press and hold the right mouse button, move your cursor over Average Frames, then release the mouse button:</li>
</ul>

<p><img src="/images/ar-sandbox/4-B-average-frames-1ba827544a.png" alt="Right Click Menu" /></p>

<ul>
  <li>Press and hold the 1 key, move your cursor over Measure 3D positions, then release the 1 key:</li>
</ul>

<p><img src="/images/ar-sandbox/5-A-measure-3d-positions-14f7ae1f35.png" alt="Measure 3D Positions" /></p>

<ul>
  <li>
    <p>You’ll now measure the 3D extents of the interior of the sandbox</p>
  </li>
  <li>
    <p>Use the color-coded depth map to make sure you position your cursor over the sand surface and not over the sides of your sandbox. Position your cursor so that there’s a small amount of space between the sand surface and the sides of your sandbox.</p>
  </li>
</ul>

<p>First, move your cursor to the lower-left interior corner, then press the 1 key:</p>

<p>Note there is no feedback from the UI when you press the 1 key.</p>

<p><img src="/images/ar-sandbox/5-B-corner1-e25b256651.png" alt="Corner 1" /></p>

<ul>
  <li>Second, move your cursor to the lower-right interior corner, then press the 1 key:</li>
</ul>

<p><img src="/images/ar-sandbox/5-B-corner2-2929d14acd.png" alt="Corner 2" /></p>

<ul>
  <li>Third, move your cursor to the upper-left interior corner, then press the 1 key:</li>
</ul>

<p><img src="/images/ar-sandbox/5-B-corner3-879f6980e8.png" alt="Corner 3" /></p>

<ul>
  <li>Finally, move your cursor to the upper-right interior corner, then press the 1 key:</li>
</ul>

<p><img src="/images/ar-sandbox/5-B-corner4-323ddfd555.png" alt="Corner 4" /></p>

<ul>
  <li>
    <p>Hit Esc to exit <code class="language-plaintext highlighter-rouge">RawKinectViewer</code>.</p>
  </li>
  <li>
    <p>In the terminal you’ll see four lines printed. You need to highlight these four lines as shown below, then right click and select Copy:</p>
  </li>
</ul>

<p><img src="/images/ar-sandbox/5-C-terminal-output-bfe04cf344.png" alt="RawKinectViewer Output" /></p>

<ul>
  <li>Edit the <code class="language-plaintext highlighter-rouge">BoxLayout.txt</code> file by running this command from the terminal:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gedit /etc/SARndbox-1.6/BoxLayout.txt
</code></pre></div></div>

<ul>
  <li>Replace the bottom four lines in BoxLayout.txt with the four lines you just copied, so you end up with something like this:</li>
</ul>

<p><img src="/images/ar-sandbox/5-D-gedit-57a97839c7.png" alt="Edited BoxLayout.txt" /></p>

<ul>
  <li>Save the file and close <code class="language-plaintext highlighter-rouge">gedit</code>.</li>
</ul>

<h2 id="postition-projector">Postition projector</h2>

<ul>
  <li>
    <p>If you haven’t already, turn on your projector and plug it into your computer.</p>
  </li>
  <li>
    <p>If you have a dedicated display in addition to the projector, you’ll find it easier if you setup the two displays to be mirrored:</p>
  </li>
</ul>

<p><img src="/images/ar-sandbox/6-A-mirror-displays-9275bf68e0.png" alt="Mirror settings" /></p>

<ul>
  <li>Launch the XBackgroud tool from a terminal like this:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>XBackground
</code></pre></div></div>

<ul>
  <li>You’ll need to position the projector so that it fills the interior of your sandbox. It’s okay if it overlaps slightly.</li>
</ul>

<p><img src="/images/ar-sandbox/6-C-xbackground-af01671469.jpg" alt="" /></p>

<p>After you’re done positioning your projector, hit Esc to close the <code class="language-plaintext highlighter-rouge">XBackgroud</code> application.</p>

<h2 id="calibrate-ar-sandbox">Calibrate AR Sandbox</h2>

<ul>
  <li>
    <p>As with step 5, this step requires you to have filed your sandbox with sand. You want the sand surface to be as level as possible, but it doesn’t need to be perfectly level.</p>
  </li>
  <li>
    <p>To calibrate your sandbox, you’ll need an alignment target and several spacers to help you perform the alignment at multiple heights:</p>
  </li>
</ul>

<p><img src="/images/ar-sandbox/7-A-tools-27804401fe.jpg" alt="Tools" /></p>

<p>The easiest way to build an alignment target is to create a target cross-hair on a piece of paper and tape it to the top of an old CD or DVD. The cross-hairs should be at right angles to one-another and be centered on the CD or DVD.</p>

<p>A few rolls of tape make great spacers. Note the rolls of tape need to have a diameter smaller than the CD or DVD you’re using for the alignment target.</p>

<p>At each height, you’ll capture 12 tie-points. For a decent calibration, you’ll need to capture tie-points at at least two heights (24 total tie-points). For an optimal calibration, we recommend capturing tie-points at three different heights (36 total tie-points).</p>

<ul>
  <li>Launch <code class="language-plaintext highlighter-rouge">CalibrateProjector</code> from a terminal like this:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CalibrateProjector -s WIDTH HEIGHT
</code></pre></div></div>

<p>Replacing WIDTH and HEIGHT with the settings for your projector. The Kinect itself has a 4:3 aspect ratio, so a resolution like 1024x768 or 1600x1200 is best.</p>

<p>To match the resolution of the laptop we used in this tutorial, we set our projector to 1920x1080, but our particular BenQ projector allows us to force a 4:3 aspect ratio even when the resolution is a 16:9 aspect ratio. So in our case, we launched <code class="language-plaintext highlighter-rouge">CalibrateProjector</code> like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CalibrateProjector -s 1920 1080
</code></pre></div></div>

<ul>
  <li>Then maximize this window so it fills your entire sandbox:</li>
</ul>

<p><img src="/images/ar-sandbox/7-maximize-478e070818.png" alt="CalibrateProjector" /></p>

<ul>
  <li>Press and hold the 1 key, move your cursor over Capture, then release the 1 key:</li>
</ul>

<p><img src="/images/ar-sandbox/7-B-press-1-17ad6d4ad8.png" alt="Tools Menu" /></p>

<ul>
  <li>Then press the 2 key when you see this dialog:</li>
</ul>

<p><img src="/images/ar-sandbox/7-C-press-2-867c3ffac3.png" alt="Capture" /></p>

<p>Press the 2 key to capture the background image, after which you’ll briefly see a uniform red color projected onto your sandbox:</p>

<p><img src="/images/ar-sandbox/7-D-capture-background-af5f6cb582.jpg" alt="Uniform Red Color" /></p>

<p>After this is completed, you can proceed with the calibration.</p>

<ul>
  <li>Next, you’ll capture tie-points at the lowest height. Using your shortest spacer, line-up your alignment target under the white cross-hairs projected onto the sand surface:</li>
</ul>

<p><img src="/images/ar-sandbox/7-E-lowest-db2aad81b1.jpg" alt="Lowest" /></p>

<p>Then press the 1 key to capture this tie-point. After a brief moment, the software will automatically move the projected cross-hairs to the next tie-point.</p>

<p>Repeat this process for the remaining 11 tie-points at this depth. Once the white projected cross-hairs are back at their original position, you’re ready to switch to a taller spacer.</p>

<ul>
  <li>Now you’ll capture tie-points at the middle height. Using a taller spacer, line-up your alignment target under the white cross-hairs projected onto the sand surface:</li>
</ul>

<p><img src="/images/ar-sandbox/7-F-middle-8e56231939.jpg" alt="Middle" /></p>

<p>Then press the 1 key to capture this tie-point. After a brief moment, the software will automatically move the projected cross-hairs to the next tie-point.</p>

<p>Repeat this process for the remaining 11 tie-points at this depth. Once the white projected cross-hairs are back at their original position, you’re ready to switch to a larger spacer.</p>

<ul>
  <li>Finally, you’ll capture tie-points at highest height. Using your tallest spacer (or stacking two spacers on top of each other), line-up your alignment target under the white cross-hairs projected onto the sand surface:</li>
</ul>

<p><img src="/images/ar-sandbox/7-G-highest-948cda7d1e.jpg" alt="Highest" /></p>

<p>Then press the 1 key to capture this tie-point. After a brief moment, the software will automatically move the projected cross-hairs to the next tie-point.</p>

<p>Repeat this process for the remaining 11 tie-points at this depth. Once the white projected cross-hairs are back at their original position, you’re done with the calibration!</p>

<ul>
  <li>Once you’ve completed the calibration, hit Esc to close the <code class="language-plaintext highlighter-rouge">CalibrateProjector</code> application.</li>
</ul>

<p>Hitting Esc will automatically write the calibration file in <code class="language-plaintext highlighter-rouge">/etc/SARndbox-1.6/ProjectorMatrix.dat</code>.</p>

<h2 id="adjust-the-sea-level">Adjust the “sea level”</h2>

<ul>
  <li>Launch the main <code class="language-plaintext highlighter-rouge">SARndbox</code> application by searching for “sandbox” in GNOME Search:</li>
</ul>

<p><img src="/images/ar-sandbox/9-A-launch-sarndbox-3d1afe80d2.png" alt="Launch SARndbox" /></p>

<ul>
  <li>Then maximize the application so it fills your entire sandbox:</li>
</ul>

<p><img src="/images/ar-sandbox/8-maximize-6789e388ee.png" alt="SARndbox" /></p>

<ul>
  <li>If in step 4 you calculated the base plane with a piece of poster board (or a similar flat surface) on top of your sandbox, your sea level will be too high, and you’ll see something like this:</li>
</ul>

<p><img src="/images/ar-sandbox/8-A-sea-level-too-high-6eaead66d8.jpg" alt="Sea Level too high" /></p>

<p>On the other hand, if in step 4 you calculated the base plane when your sandbox was empty, the sea level will be too low. Either way, you’ll want to adjust the sea level so it’s just below the surface of your sand when it’s more or less flattened out.</p>

<ul>
  <li>
    <p>Hit Esc to close the AR Sandbox application.</p>
  </li>
  <li>
    <p>To adjust the sea level, edit the <code class="language-plaintext highlighter-rouge">/etc/SARndbox-1.6/BoxLayout.txt</code> by running this command from the terminal:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gedit /etc/SARndbox-1.6/BoxLayout.txt
</code></pre></div></div>

<p>The value highlighted below in <code class="language-plaintext highlighter-rouge">BoxLayout.txt</code> controls the sea-level:</p>

<p><img src="/images/ar-sandbox/8-B-gedit-1-66e79657fe.png" alt="BoxLayout1" /></p>

<ul>
  <li>You’ll want to adjust the final value in the first line to be roughly the same as the smallest of the final value on the four lines at the end.
In our example <code class="language-plaintext highlighter-rouge">-106.927</code> is the smallest value:</li>
</ul>

<p><img src="/images/ar-sandbox/8-C-gedit-2-6673dc3a21.png" alt="BoxLayout2" /></p>

<p>So we’ll set the sea-level to <code class="language-plaintext highlighter-rouge">-107</code>, like this:</p>

<p><img src="/images/ar-sandbox/8-D-gedit-3-36f32a4191.png" alt="BoxLayout3" /></p>

<ul>
  <li>
    <p>Save the file and close <code class="language-plaintext highlighter-rouge">gedit</code>.</p>
  </li>
  <li>
    <p>Re-launch the AR Sandbox application from the Ubuntu dash, maximize the window, and you’ll see something like this:</p>
  </li>
</ul>

<p><img src="/images/ar-sandbox/8-E-sea-level-just-right-cdc5f0037b.jpg" alt="Sea Level just right" /></p>

<p>You can experiment with different values for the sea-level to suite your preferences, but our recommendations here will give you a good starting point.</p>

<p>Note that you can adjust the sea level at any time in the future without recalibrating your sandbox.</p>

<h2 id="use-the-sandbox">Use the Sandbox!</h2>

<ul>
  <li>
    <p>Whew! You made it through the setup and calibration!
As long as you don’t change the physical setup of your sandbox (in particular, the position of the Kinect, the projector, and the sandbox relative to each other), you never need to calibrate it again. Although now that you have the hang of it, you might want to go through the calibration again in order to achieve a more accurate setup.</p>
  </li>
  <li>
    <p>If you hold your hand above the sand surface (like a cloud), you can “make it rain”:</p>
  </li>
</ul>

<p><img src="/images/ar-sandbox/9-B-make-it-rain-fe5051a11f.jpg" alt="Make it rain" /></p>

<ul>
  <li>As a convenience, the System76 packaging for Ubuntu includes a launcher you can search for in the GNOME Search:</li>
</ul>

<p><img src="/images/ar-sandbox/9-A-launch-sarndbox-3d1afe80d2.png" alt="Launch SARndbox" /></p>

<p>This is a shortcut to launch <code class="language-plaintext highlighter-rouge">SARndbox</code> with the following arguments (which you can also do directly from a terminal):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SARndbox -uhm -fpv -evr -0.01
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">-evr -0.01</code> bit of the above command sets the evaporation rate. Without any evaporation rate set, the sandbox will steadily fill with more and more water as you “make it rain”, which eventually will cause the real-time fluid simulation to become slow.</p>

<p>So you typically want to set an evaporation rate, especially when deploying the Augmented Reality Sandbox in schools or museums.</p>

<ul>
  <li>If our recommended evaporation rate seems too fast for your tastes, try:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SARndbox -uhm -fpv -evr -0.005
</code></pre></div></div>

<p>If our recommended evaporation rate seems too slow for your tastes, try:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SARndbox -uhm -fpv -evr -0.02
</code></pre></div></div>

<p>Thanks again to <a href="http://idav.ucdavis.edu/~okreylos/">Oliver Kreylos</a> for developing such an incredible, inspiring piece of software!</p>

<p>Be sure to check out the <a href="https://arsandbox.ucdavis.edu/">Augmented Reality Sandbox</a> website for more details.</p>

